{
  "hash": "e6513a322b986b8e4dc0677509648fae",
  "result": {
    "markdown": "---\ntitle: \"Take-home Exercise 02\"\nformat:\n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\n\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\ndate: \"2024-02-28\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, tmap, tidyverse, lubridate, dplyr, sfdep)\n```\n:::\n\n\n## Load the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- read_csv(\"data/aspatial/Dengue_Daily.csv\")\n```\n:::\n\n\nmutate to rename onset date filter to 台南市\n\nonset date -\\> when you kena dengue, when your first symptom appear\n\nrename dengue's first column to onset date\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(dengue)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(dengue)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nunique(dengue$居住縣市)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue <- dengue %>%\n  filter(居住縣市 == \"台南市\") %>%\n  filter(!(最小統計區中心點X == \"None\") | !(最小統計區中心點Y == \"None\"))  %>% \n  filter(發病日 >= \"2023-07-30\" & 發病日 <= \"2023-12-16\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- dengue %>%\n  select(\"發病日\", \"最小統計區中心點X\", \"最小統計區中心點Y\")\n```\n:::\n\n\nhttps://stackoverflow.com/questions/46014332/using-mutate-in-r-to-rename-items-in-a-column\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(df) <- c(\"onset-date\", \"x-coordinate\",\"y-coordinate\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntainan <- st_read(dsn = \"data/geospatial\", \n                 layer = \"TAINAN_VILLAGE\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(tainan)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nst_crs(tainan)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(which(st_is_valid(tainan) == FALSE))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_sf <- st_as_sf(df, \n                      coords = c(\"x-coordinate\",\"y-coordinate\"),\n                      crs = 3824)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvillages <- c(\"D01\", \"D02\", \"D04\", \"D06\", \"D07\", \"D08\", \"D32\", \"D39\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntainan_vil <- tainan %>%\n  filter(TOWNID %in% villages)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\noverall_dengue <- st_intersection(dengue_sf, tainan_vil)\n```\n:::\n\n\nsave overall dengue in rds\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(overall_dengue, \"data/rds/overall_dengue.rds\")\nsaveRDS(tainan_vil, \"data/rds/tainan_vil.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\noverall_dengue <- readRDS(\"data/rds/overall_dengue.rds\")\ntainan_vil <- readRDS(\"data/rds/tainan_vil.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_geometry(tainan_vil), col = \"grey\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n\nhttps://lubridate.tidyverse.org/reference/week.html\n\nadd a column in overall_dengue to show the week of the year based on onset-date using epiweek\n\nuse epi week to start on sunday instead of isoweek which starts on monday\n\n\n::: {.cell}\n\n```{.r .cell-code}\noverall_dengue <- overall_dengue %>%\n  mutate(week = lubridate::epiweek(onset.date))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\noverall_dengue <- overall_dengue %>% select(onset.date,VILLENG, TOWNID, geometry,week)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(st_geometry(overall_dengue), col = \"grey\")\nplot(st_geometry(tainan_vil), add = TRUE)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_count <- st_join(tainan_vil, overall_dengue, join =st_contains ) %>%\n  group_by(TOWNID.x, week) %>%\n  summarise(cases = n())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(dengue_count)\n```\n:::\n\nsave overall_dengue into rds \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(dengue_count, \"data/rds/dengue_count.rds\")\nsaveRDS(overall_dengue, \"data/rds/overall_dengue.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_count <- readRDS(\"data/rds/dengue_count.rds\")\noverall_dengue <- readRDS(\"data/rds/overall_dengue.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(dengue_count) + \n  tm_polygons(\"cases\") + \n  tm_layout(main.title = \"Number of dengue cases by Village\", \n            main.title.position = \"center\",\n            main.title.size = 1.2,\n            legend.height = 0.45,\n            legend.width=0.35,\n            frame = TRUE) + \n  tm_borders(alpha=0.5)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\nplot a bar chart to show the distribuition of dengue cases in each village\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(dengue_count, aes(x = week, y = cases, fill = TOWNID.x)) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +\n  labs(title = \"Dengue cases in Tainan\",\n       x = \"Week\",\n       y = \"Number of cases\")\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\nFrom the chart above, we can notice that village D32 generally has lesser amount of dengue cases compared to the rest of the villages. Meanwhile, village D06 came up as an oddity where it was relatively low then spiked up in week 35-40. \n\n\ncomputing spatial weights\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengue_agg <- dengue_count %>% select(week, cases, geometry)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwm_q <- dengue_agg %>% mutate(nb = st_contiguity(geometry),\n                                        wt = st_weights(nb, \n                                                        style = \"W\"),\n                                        .before=1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwm_q\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 160 features and 4 fields\nGeometry type: GEOMETRY\nDimension:     XY\nBounding box:  xmin: 120.0627 ymin: 22.89401 xmax: 120.2925 ymax: 23.09144\nGeodetic CRS:  TWD97\n# A tibble: 160 × 5\n   nb          wt           week cases                                  geometry\n * <nb>        <list>      <dbl> <int>                            <GEOMETRY [°]>\n 1 <int [68]>  <dbl [68]>     31    72 MULTIPOLYGON (((120.2371 22.96098, 120.2…\n 2 <int [111]> <dbl [111]>    32   109 MULTIPOLYGON (((120.2418 22.98269, 120.2…\n 3 <int [88]>  <dbl [88]>     33   108 POLYGON ((120.2389 22.98011, 120.239 22.…\n 4 <int [110]> <dbl [110]>    34   163 MULTIPOLYGON (((120.2173 22.9606, 120.21…\n 5 <int [111]> <dbl [111]>    35   289 POLYGON ((120.2382 22.97065, 120.2382 22…\n 6 <int [111]> <dbl [111]>    36   417 POLYGON ((120.2492 22.98232, 120.2492 22…\n 7 <int [111]> <dbl [111]>    37   370 POLYGON ((120.2492 22.98232, 120.2492 22…\n 8 <int [111]> <dbl [111]>    38   372 POLYGON ((120.2389 22.98011, 120.239 22.…\n 9 <int [111]> <dbl [111]>    39   421 POLYGON ((120.2492 22.98788, 120.2491 22…\n10 <int [111]> <dbl [111]>    40   403 POLYGON ((120.2478 22.99068, 120.2478 22…\n# ℹ 150 more rows\n```\n:::\n:::\n\nPerforming Global Moran’s I test\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_moran_test(wm_q$cases,\n                  wm_q$nb,\n                  wm_q$wt)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tMoran I test under randomisation\n\ndata:  x  \nweights: listw    \n\nMoran I statistic standard deviate = -0.06349, p-value = 0.5253\nalternative hypothesis: greater\nsample estimates:\nMoran I statistic       Expectation          Variance \n    -6.858754e-03     -6.289308e-03      8.044415e-05 \n```\n:::\n:::\n\n\n Performing Global Moran’s I permutation test\n \n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglobal_moran_perm(wm_q$cases,\n                  wm_q$nb,\n                  wm_q$wt,\n                  nsim=49)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tMonte-Carlo simulation of Moran I\n\ndata:  x \nweights: listw  \nnumber of simulations + 1: 50 \n\nstatistic = -0.0068588, observed rank = 23, p-value = 0.92\nalternative hypothesis: two.sided\n```\n:::\n:::\n\n Local Spatial Autocorrelation Analysis\n \n \ncomputing lisa \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa <- wm_q %>% mutate(local_moran = local_moran(\n  cases, nb, wt, nsim = 49),\n  .before = 1) %>%\n  unnest(local_moran)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(lisa) + \n  tm_fill(\"ii\") + \n  tm_borders(alpha=0.5) +\n  tm_layout(main.title = \"Local Moran's I of Total Cases\", \n            main.title.size = 0.8)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(lisa) +\n  tm_fill(\"p_ii_sim\",\n          breaks = c(0, 0.001, 0.01, 0.05, 1),\n          labels = c(\"0.001\", \"0.01\", \"0.05\", \"Not significant\")) +\n  tm_borders(alpha = 0.5) +\n  tm_layout (main.title = \"p-value of local Moran's I\",\n             main.title.size = 0.8)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlocal_mapi <- tm_shape(lisa) + \n  tm_fill(\"ii\") + \n  tm_borders(alpha=0.5) +\n  tm_layout(main.title = \"Local Moran's I of Total Cases\", \n            main.title.size = 0.8)\n\nlocal_mapp <- tm_shape(lisa) +\n  tm_fill(\"p_ii_sim\",\n          breaks = c(0, 0.001, 0.01, 0.05, 1),\n          labels = c(\"0.001\", \"0.01\", \"0.05\", \"Not significant\")) +\n  tm_borders(alpha = 0.5) +\n  tm_layout (main.title = \"p-value of local Moran's I\",\n             main.title.size = 0.8)\n\ntmap_arrange(local_mapi, local_mapp, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlisa_sig <- lisa %>% filter(p_ii <0.05)\n\ntm_shape(lisa) + \n  tm_polygons() +\n  tm_borders(alpha = 0.5) +\n  tm_shape(lisa_sig) +\n  tm_fill(\"mean\") +\n  tm_borders(alpha=0.4)\n```\n\n::: {.cell-output-display}\n![](Take-home_Ex02_files/figure-html/unnamed-chunk-39-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Take-home_Ex02_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}